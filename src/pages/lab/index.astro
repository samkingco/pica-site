---
import { getCollection } from "astro:content";
import Default from "../../layouts/Default.astro";
import Link from "../../components/Link.astro";

const labEntries = await getCollection("lab");

// Group by series and get all versions
const seriesMap = new Map();
for (const entry of labEntries) {
	const series = entry.data.series || entry.slug;
	const version = entry.data.version || 1;
	
	if (!seriesMap.has(series)) {
		seriesMap.set(series, { latest: null, versions: [] });
	}
	
	const seriesData = seriesMap.get(series);
	seriesData.versions.push(entry);
	
	if (!seriesData.latest || version > (seriesData.latest.data.version || 1)) {
		seriesData.latest = entry;
	}
}

const latestBySeries = await Promise.all(
	Array.from(seriesMap.entries())
		.map(async ([series, data]) => {
			const { Content } = await data.latest.render();
			return {
				series,
				entry: data.latest,
				Content,
				versions: data.versions.sort((a, b) => (a.data.version || 1) - (b.data.version || 1))
			};
		})
)
	.then(results => results.sort((a, b) => b.entry.data.date.getTime() - a.entry.data.date.getTime()));
---

<Default title="lab" description="Interactive experiments and visual explorations">
	<script is:inline src="/p5.min.js"></script>
	
	<article class="space-y-5">
		<h2 class="text-muted-foreground">lab</h2>
		<p>interactive experiments, generative art, and visual explorations</p>
	</article>
	
	<div class="space-y-16 mt-16">
		{latestBySeries.map(({ series, entry, Content, versions }) => {
			const showVersions = versions.length > 1;
			return (
				<article>
					<div class="relative">
						<div class="w-full md:max-w-[72ch] space-y-5 markdown">
							<Content />
						</div>
						
						{showVersions && (
							<aside class="mt-10 md:mt-0 md:absolute md:left-[calc(72ch+2.5rem)] md:top-0 md:w-64">
								<nav class="md:sticky md:top-10 space-y-3">
									<h3 class="text-muted-foreground">versions</h3>
									<ul class="space-y-3 md:max-h-[70vh] md:overflow-y-auto">
										{versions.reverse().map((v) => {
											const isCurrent = v.slug === entry.slug;
											return (
												<li>
													{isCurrent ? (
														<div class="space-y-1">
															<div class="font-bold">v{v.data.version || 1}: {v.data.title.replace(/^murmuration v\d+:?\s*/i, '')}</div>
														</div>
													) : (
														<Link href={`/lab/${v.slug}`}>
															<div class="space-y-1">
																<div>v{v.data.version || 1}: {v.data.title.replace(/^murmuration v\d+:?\s*/i, '')}</div>
															</div>
														</Link>
													)}
												</li>
											);
										})}
									</ul>
								</nav>
							</aside>
						)}
					</div>
				</article>
			);
		})}
	</div>
</Default>

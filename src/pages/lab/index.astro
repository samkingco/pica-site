---
import { getCollection } from "astro:content";
import Default from "../../layouts/Default.astro";
import Link from "../../components/Link.astro";

const labEntries = await getCollection("lab");

// Group by series and get latest version of each
const seriesMap = new Map();
for (const entry of labEntries) {
	const series = entry.data.series || entry.slug;
	const version = entry.data.version || 1;
	
	const existing = seriesMap.get(series);
	if (!existing || version > existing.version) {
		seriesMap.set(series, {
			...entry,
			version
		});
	}
}

const latestBySeries = Array.from(seriesMap.values())
	.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<Default title="lab" description="Interactive experiments and visual explorations">
	<article class="space-y-5">
		<h2 class="text-muted-foreground">lab</h2>
		<p>Interactive experiments, generative art, and visual explorations. Each series shows the latest version.</p>
		
		<ul class="space-y-8">
			{latestBySeries.map((entry) => {
				const series = entry.data.series || entry.slug;
				return (
					<li class="space-y-2">
						<Link href={`/lab/${series}`}>
							<h3 class="text-foreground">{entry.data.title}</h3>
						</Link>
						<p class="text-muted-foreground text-sm">{entry.data.excerpt}</p>
						<p class="text-muted-foreground text-xs">
							{entry.data.date.toLocaleDateString('en-US', { 
								year: 'numeric', 
								month: 'long', 
								day: 'numeric' 
							})}
						</p>
					</li>
				);
			})}
		</ul>
	</article>
</Default>

---
import { getCollection } from "astro:content";
import Lab from "../../layouts/Lab.astro";

export async function getStaticPaths() {
	const labEntries = await getCollection("lab");
	const allLab = labEntries;
	
	// Create paths for individual entries
	const entryPaths = labEntries.map((entry) => ({
		params: { slug: entry.slug },
		props: { entry },
	}));
	
	// Create redirect paths for series names (point to latest version)
	const seriesMap = new Map();
	for (const entry of allLab) {
		const series = entry.data.series || entry.slug;
		const version = entry.data.version || 1;
		const existing = seriesMap.get(series);
		if (!existing || version > existing.version) {
			seriesMap.set(series, { entry, version });
		}
	}
	
	const seriesPaths = Array.from(seriesMap.entries())
		.filter(([series, { entry }]) => series !== entry.slug) // Only if series name differs from slug
		.map(([series, { entry }]) => ({
			params: { slug: series },
			props: { entry },
		}));
	
	return [...entryPaths, ...seriesPaths];
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get all versions in this series
const allLab = await getCollection("lab");
const series = entry.data.series || entry.slug;
const versions = allLab
	.filter(e => (e.data.series || e.slug) === series)
	.sort((a, b) => (a.data.version || 1) - (b.data.version || 1));
---

<Lab 
	title={entry.data.title} 
	excerpt={entry.data.excerpt}
	versions={versions}
	currentSlug={entry.slug}
>
	<Content />
</Lab>
